{% extends "base.html" %}

{% block title %}首页 - 卡盟微信管理后台{% endblock %}

{% block page_title %}首页{% endblock %}

{% block head %}
<style>
    /* 自定义动画 */
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .animate-pulse-slow {
        animation: pulse 2s infinite;
    }
    
    /* 扫码提示动画 */
    @keyframes scanwave {
        0% { transform: scale(1); opacity: 0.8; }
        70% { transform: scale(1.5); opacity: 0; }
        100% { transform: scale(1.5); opacity: 0; }
    }
    
    .scan-wave {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 60%;
        height: 60%;
        border-radius: 50%;
        background-color: rgba(16, 185, 129, 0.2);
        transform: translate(-50%, -50%);
    }
    
    .scan-wave-animation {
        animation: scanwave 2s infinite;
    }
    
    /* 状态标签样式 */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-badge-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
        margin-right: 0.25rem;
    }
    
    /* 快捷入口样式 */
    .shortcut-item {
        transition: all 0.2s;
    }
    
    .shortcut-item:hover {
        transform: translateY(-3px);
    }
</style>
{% endblock %}

{% block content %}
<div id="dashboardApp">
    <!-- 状态概览区域 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- 面板状态卡片 -->
        <div class="bg-white rounded-xl shadow-card overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fa-solid fa-display text-purple-500 mr-2"></i>面板状态
                </h2>
                <button @click="restartWebPanel" class="p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" :disabled="processing" title="重启面板">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-1 gap-4">
                    <!-- 系统状态指标(横向排列) -->
                    <div class="grid grid-cols-3 gap-3">
                        <!-- 运行时长 -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center mb-1">
                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 mr-2">
                                    <i class="fa-solid fa-clock"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-600 hidden sm:inline">运行时长</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-base font-semibold text-gray-800">[[ systemStats.panel_uptime ]]</p>
                                <span class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded-full">面板</span>
                            </div>
                        </div>
                        
                        <!-- CPU使用率 -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center mb-1">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-2">
                                    <i class="fa-solid fa-microchip"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-600 hidden sm:inline">CPU使用率</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-base font-semibold text-gray-800">[[ systemStats.cpu_usage ]]</p>
                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue-600 h-1.5 rounded-full" :style="{width: systemStats.cpu_percent + '%'}"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 内存使用率 -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center mb-1">
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 mr-2">
                                    <i class="fa-solid fa-memory"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-600 hidden sm:inline">内存使用率</span>
                            </div>
                            <div class="flex justify-between items-center mt-1">
                                <p class="text-base font-semibold text-gray-800">[[ systemStats.memory_usage ]]</p>
                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-green-600 h-1.5 rounded-full" :style="{width: systemStats.memory_percent + '%'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 快捷入口 -->
                    <div class="grid grid-cols-5 gap-2">
                        <a href="/chat" class="shortcut-item flex flex-col items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 mb-1">
                                <i class="fa-solid fa-comments"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 text-center">聊天管理</span>
                        </a>
                        <a href="/mass_message" class="shortcut-item flex flex-col items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 mb-1">
                                <i class="fa-solid fa-paper-plane"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 text-center">群发消息</span>
                        </a>
                        <a href="/autoreply" class="shortcut-item flex flex-col items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 mb-1">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 text-center">自动回复</span>
                        </a>
                        <a href="/plugins" class="shortcut-item flex flex-col items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 mb-1">
                                <i class="fa-solid fa-puzzle-piece"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 text-center">插件管理</span>
                        </a>
                        <a href="/settings" class="shortcut-item flex flex-col items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mb-1">
                                <i class="fa-solid fa-cog"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 text-center">系统设置</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 微信状态卡片 -->
        <div class="bg-white rounded-xl shadow-card overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fa-brands fa-weixin text-green-500 mr-2"></i>微信状态
                </h2>
                <button v-if="status.is_online" @click="logoutGewechat" class="p-2 text-gray-500 hover:text-danger-600 hover:bg-danger-50 rounded-lg transition-colors" :disabled="processing" title="退出登录">
                    <i class="fa-solid fa-sign-out-alt"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="flex flex-wrap md:flex-nowrap">
                    <!-- 头像/二维码区域 -->
                    <div class="w-full md:w-1/3 flex justify-center items-center mb-6 md:mb-0 md:pr-6">
                        <div v-if="status.is_online && status.avatar_path" class="text-center">
                            <div class="relative inline-block rounded-full p-1 bg-gradient-to-r from-green-400 to-teal-400">
                                <img :src="status.avatar_path" alt="用户头像" class="w-32 h-32 object-cover rounded-full border-4 border-white">
                            </div>
                        </div>
                        <div v-else-if="!status.is_online && status.qrcode_path" class="text-center">
                            <p class="text-sm text-gray-500 mb-3">请使用微信扫码登录</p>
                            <div class="relative inline-block rounded-xl overflow-hidden shadow-md">
                                <div class="scan-wave scan-wave-animation"></div>
                                <img :src="status.qrcode_path" alt="登录二维码" class="w-40 h-40 object-cover">
                            </div>
                            <button @click="refreshQRCode" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-green-600 bg-green-50 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fa-solid fa-arrows-rotate mr-2"></i>
                                刷新二维码
                            </button>
                        </div>
                    </div>
                    
                    <!-- 状态详情区域 -->
                    <div class="w-full md:w-2/3 md:border-l md:border-gray-100 md:pl-6">
                        <div class="grid grid-cols-2 gap-4">
                            <!-- 登录状态 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fa-solid fa-user-check text-green-500 mr-2"></i>
                                    <span class="text-sm font-medium text-gray-500">登录状态</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="status-badge" 
                                          :class="{'bg-green-100 text-green-800': status.is_online, 'bg-red-100 text-red-800': !status.is_online}">
                                        <span class="status-badge-dot" :class="{'bg-green-500': status.is_online, 'bg-red-500': !status.is_online}"></span>
                                        [[ status.is_online ? '已登录' : '未登录' ]]
                                    </span>
                                </div>
                            </div>
                            
                            <!-- 当前用户 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fa-solid fa-id-card text-green-500 mr-2"></i>
                                    <span class="text-sm font-medium text-gray-500">当前用户</span>
                                </div>
                                <div class="font-semibold text-gray-800 truncate">
                                    [[ status.nickname || '未登录' ]]
                                </div>
                            </div>
                            
                            <!-- 微信类型 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fa-brands fa-weixin text-green-500 mr-2"></i>
                                    <span class="text-sm font-medium text-gray-500">微信类型</span>
                                </div>
                                <div class="font-semibold text-gray-800">
                                    [[ status.channel_type || 'Unknown' ]]
                                </div>
                            </div>
                            
                            <!-- 登录时长 -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="fa-solid fa-clock text-green-500 mr-2"></i>
                                    <span class="text-sm font-medium text-gray-500">登录时长</span>
                                </div>
                                <div class="font-semibold text-gray-800">
                                    {{ login_duration if login_duration else '未登录' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot状态卡片 -->
        <div class="bg-white rounded-xl shadow-card overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fa-solid fa-robot text-blue-500 mr-2"></i>Bot状态
                </h2>
                <div class="flex gap-2">
                    <button v-if="status.is_running" @click="stopService" class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" :disabled="processing" title="停止Bot">
                        <i class="fa-solid fa-stop"></i>
                    </button>
                    <button v-if="!status.is_running" @click="startService" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" :disabled="processing" title="启动Bot">
                        <i class="fa-solid fa-play"></i>
                    </button>
                    <button @click="restartService" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" :disabled="processing" title="重启Bot">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </button>
                </div>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-1 gap-4">
                    <!-- 运行状态指标 -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-3">
                                <i class="fa-solid fa-server"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-600">运行状态</h3>
                                <p class="text-base font-semibold text-gray-800">[[ status.is_running ? '运行中' : '已停止' ]]</p>
                            </div>
                        </div>
                        <span class="status-badge" 
                              :class="{'bg-green-100 text-green-800': status.is_running, 'bg-red-100 text-red-800': !status.is_running}">
                            <span class="status-badge-dot" :class="{'bg-green-500': status.is_running, 'bg-red-500': !status.is_running}"></span>
                            [[ status.is_running ? '运行中' : '已停止' ]]
                        </span>
                    </div>
                    
                    <!-- Bot配置信息 -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="flex items-center mb-2">
                            <i class="fa-solid fa-gear text-blue-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-500">Bot配置信息</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-600 font-medium">AppID:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs">{{ config.gewechat_app_id }}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-600 font-medium">Token:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs">{{ config.gewechat_token }}</span>
                            </div>
                            <div class="flex flex-col col-span-2">
                                <span class="text-xs text-gray-600 font-medium">Base URL:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs break-all">{{ config.gewechat_base_url }}</span>
                            </div>
                            <div class="flex flex-col col-span-2">
                                <span class="text-xs text-gray-600 font-medium">Callback URL:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs break-all">{{ config.gewechat_callback_url }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI状态卡片 -->
        <div class="bg-white rounded-xl shadow-card overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fa-solid fa-brain text-pink-500 mr-2"></i>AI状态
                </h2>
                <a href="/api_test" class="p-2 text-gray-500 hover:text-pink-600 hover:bg-pink-50 rounded-lg transition-colors" title="测试API">
                    <i class="fa-solid fa-vial"></i>
                </a>
            </div>
            <div class="p-5">
                <div class="grid grid-cols-1 gap-4">
                    <!-- 接口状态 -->
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center text-pink-600 mr-3">
                                <i class="fa-solid fa-plug"></i>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-600">接口状态</h3>
                                <p class="text-base font-semibold text-gray-800">[[ systemStats.dify_api_status === '正常' ? '连接正常' : systemStats.dify_api_status === '异常' ? '连接异常' : systemStats.dify_api_status ]]</p>
                            </div>
                        </div>
                        <span class="status-badge" 
                              :class="{'bg-green-100 text-green-800': systemStats.dify_api_status === '正常', 'bg-red-100 text-red-800': systemStats.dify_api_status === '异常', 'bg-yellow-100 text-yellow-800': systemStats.dify_api_status !== '正常' && systemStats.dify_api_status !== '异常'}">
                            <span class="status-badge-dot" 
                                  :class="{'bg-green-500': systemStats.dify_api_status === '正常', 'bg-red-500': systemStats.dify_api_status === '异常', 'bg-yellow-500': systemStats.dify_api_status !== '正常' && systemStats.dify_api_status !== '异常'}"></span>
                            [[ systemStats.dify_api_status === '正常' ? '已连接' : systemStats.dify_api_status === '异常' ? '未连接' : '检测中' ]]
                        </span>
                    </div>
                    
                    <!-- AI配置信息 -->
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="flex items-center mb-2">
                            <i class="fa-solid fa-gear text-pink-500 mr-2"></i>
                            <span class="text-sm font-medium text-gray-500">AI配置信息</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-600 font-medium">API Key:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs">{{ config.dify_api_key }}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-600 font-medium">App Type:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs">{{ config.dify_app_type }}</span>
                            </div>
                            <div class="flex flex-col col-span-2">
                                <span class="text-xs text-gray-600 font-medium">API Base:</span>
                                <span class="text-gray-800 font-mono bg-gray-100 rounded px-2 py-1 mt-1 text-xs break-all">{{ config.dify_api_base }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 确认重启对话框 -->
    <div v-if="showRestartConfirm" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showRestartConfirm = false"></div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-robot text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">确认重启Bot</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">确定要重启Bot服务吗？重启过程可能需要几秒钟时间，不会影响Web界面。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="confirmRestart" :disabled="processing" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                        确认重启
                    </button>
                    <button type="button" @click="showRestartConfirm = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 确认退出对话框 -->
    <div v-if="showLogoutConfirm" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showLogoutConfirm = false"></div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-sign-out-alt text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">确认退出</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">确定要退出当前登录的微信账号吗？</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="confirmLogout" :disabled="processing" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        确认退出
                    </button>
                    <button type="button" @click="showLogoutConfirm = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 提示框 -->
    <div id="toast" 
         class="fixed bottom-4 right-4 flex items-center p-4 space-x-4 w-full max-w-xs text-gray-500 bg-white rounded-lg divide-x divide-gray-200 shadow-md space-x transition-opacity duration-300 opacity-0 pointer-events-none transform translate-y-6">
        <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
        <div class="pl-4 text-sm font-normal" id="toast-message"></div>
    </div>

    <!-- 确认重启Web面板对话框 -->
    <div v-if="showRestartWebPanelConfirm" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showRestartWebPanelConfirm = false"></div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-display text-purple-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">确认重启Web面板</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">确定要重启Web面板吗？重启过程中页面将暂时不可访问，几秒钟后会自动刷新。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="confirmRestartWebPanel" :disabled="processing" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm">
                        确认重启
                    </button>
                    <button type="button" @click="showRestartWebPanelConfirm = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认停止服务对话框 -->
    <div v-if="showStopConfirm" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showStopConfirm = false"></div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-stop text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">确认停止Bot</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">确定要停止Bot服务吗？停止后将无法接收和处理新消息，直到重新启动服务。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="confirmStop" :disabled="processing" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        确认停止
                    </button>
                    <button type="button" @click="showStopConfirm = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 确认启动服务对话框 -->
    <div v-if="showStartConfirm" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showStartConfirm = false"></div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fa-solid fa-play text-green-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">确认启动Bot</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">确定要启动Bot服务吗？启动后将开始接收和处理微信消息。</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="confirmStart" :disabled="processing" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        确认启动
                    </button>
                    <button type="button" @click="showStartConfirm = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const Dashboard = {
            delimiters: ['[[', ']]'],
            data() {
                return {
                    status: {
                        is_running: false,
                        is_online: false,
                        nickname: null,
                        avatar_path: null,
                        qrcode_path: null,
                        channel_type: ''
                    },
                    config: {
                        gewechat_app_id: '{{ config.gewechat_app_id }}',
                        gewechat_base_url: '{{ config.gewechat_base_url }}',
                        gewechat_callback_url: '{{ config.gewechat_callback_url }}',
                        gewechat_token: '{{ config.gewechat_token }}',
                        dify_api_base: '{{ config.dify_api_base }}',
                        dify_api_key: '{{ config.dify_api_key }}',
                        dify_app_type: '{{ config.dify_app_type }}'
                    },
                    systemStats: {
                        cpu_usage: '{{ cpu_usage if cpu_usage else "0%" }}',
                        memory_usage: '{{ memory_usage if memory_usage else "0%" }}',
                        panel_uptime: '{{ panel_uptime if panel_uptime else "未知" }}',
                        dify_api_status: '{{ dify_api_status if dify_api_status else "检测中" }}'
                    },
                    showRestartConfirm: false,
                    showLogoutConfirm: false,
                    showRestartWebPanelConfirm: false,
                    showStopConfirm: false,
                    showStartConfirm: false,
                    processing: false
                }
            },
            mounted() {
                this.loadStatus();
                this.checkDifyApiStatus();
                // 每60秒自动刷新一次状态
                setInterval(this.loadStatus, 60000);
                // 每5分钟检查一次API状态
                setInterval(this.checkDifyApiStatus, 300000);
            },
            methods: {
                loadStatus() {
                    axios.get('/api/status')
                        .then(response => {
                            this.status = response.data;
                            // 同时获取系统状态信息
                            this.getSystemStats();
                        })
                        .catch(error => {
                            console.error('获取状态失败:', error);
                        });
                },
                getSystemStats() {
                    axios.get('/api/system_stats')
                        .then(response => {
                            if (response.data.success) {
                                this.systemStats = response.data;
                            }
                        })
                        .catch(error => {
                            console.error('获取系统状态失败:', error);
                        });
                },
                checkDifyApiStatus() {
                    axios.get('/api/check_dify')
                        .then(response => {
                            if (response.data.success) {
                                this.systemStats.dify_api_status = '正常';
                            } else {
                                this.systemStats.dify_api_status = '异常';
                            }
                        })
                        .catch(error => {
                            console.error('检查Dify API状态失败:', error);
                            this.systemStats.dify_api_status = '异常';
                        });
                },
                restartWebPanel() {
                    this.showRestartWebPanelConfirm = true;
                },
                confirmRestartWebPanel() {
                    this.processing = true;
                    axios.post('/api/restart_webpanel')
                        .then(response => {
                            this.showRestartWebPanelConfirm = false;
                            if (response.data.success) {
                                this.showToast('Web面板正在重启，请等待几秒后刷新页面', 'success');
                                // 5秒后自动刷新页面
                                setTimeout(() => {
                                    window.location.reload();
                                }, 5000);
                            } else {
                                this.showToast('重启Web面板失败: ' + response.data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('重启Web面板失败:', error);
                            this.showToast('重启Web面板失败', 'error');
                        })
                        .finally(() => {
                            this.processing = false;
                        });
                },
                restartService() {
                    this.showRestartConfirm = true;
                },
                confirmRestart() {
                    this.processing = true;
                    axios.post('/api/restart')
                        .then(response => {
                            this.showRestartConfirm = false;
                            if (response.data.success) {
                                this.showToast('服务已重启', 'success');
                                setTimeout(() => {
                                    this.loadStatus();
                                }, 5000); // 5秒后刷新状态
                            } else {
                                this.showToast('重启失败: ' + response.data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('重启失败:', error);
                            this.showToast('重启失败', 'error');
                        })
                        .finally(() => {
                            this.processing = false;
                        });
                },
                logoutGewechat() {
                    this.showLogoutConfirm = true;
                },
                confirmLogout() {
                    this.processing = true;
                    axios.post('/api/logout_gewechat')
                        .then(response => {
                            this.showLogoutConfirm = false;
                            if (response.data.success) {
                                this.showToast('已退出登录', 'success');
                                this.loadStatus(); // 刷新状态
                            } else {
                                this.showToast('退出失败: ' + response.data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('退出失败:', error);
                            this.showToast('退出失败', 'error');
                        })
                        .finally(() => {
                            this.processing = false;
                        });
                },
                refreshQRCode() {
                    this.processing = true;
                    // 添加时间戳强制刷新缓存
                    this.status.qrcode_path = this.status.qrcode_path + '?t=' + new Date().getTime();
                    this.processing = false;
                },
                showToast(message, type = 'info') {
                    const toast = document.getElementById('toast');
                    const toastIcon = document.getElementById('toast-icon');
                    const toastMessage = document.getElementById('toast-message');
                    
                    // 设置消息
                    toastMessage.textContent = message;
                    
                    // 根据类型设置图标和样式
                    if (type === 'success') {
                        toastIcon.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg';
                        toastIcon.innerHTML = '<i class="fa-solid fa-check"></i>';
                    } else if (type === 'error') {
                        toastIcon.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg';
                        toastIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    } else if (type === 'warning') {
                        toastIcon.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-orange-500 bg-orange-100 rounded-lg';
                        toastIcon.innerHTML = '<i class="fa-solid fa-exclamation"></i>';
                    } else {
                        toastIcon.className = 'inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg';
                        toastIcon.innerHTML = '<i class="fa-solid fa-info"></i>';
                    }
                    
                    // 显示toast
                    toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-6');
                    toast.classList.add('opacity-100', 'translate-y-0');
                    
                    // 3秒后自动关闭
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-6');
                        toast.classList.remove('opacity-100', 'translate-y-0');
                    }, 3000);
                },
                stopService() {
                    this.showStopConfirm = true;
                },
                confirmStop() {
                    this.processing = true;
                    axios.post('/api/stop')
                        .then(response => {
                            this.showStopConfirm = false;
                            if (response.data.success) {
                                this.showToast('服务已停止', 'success');
                                setTimeout(() => {
                                    this.loadStatus();
                                }, 5000); // 5秒后刷新状态
                            } else {
                                this.showToast('停止失败: ' + response.data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('停止失败:', error);
                            this.showToast('停止失败', 'error');
                        })
                        .finally(() => {
                            this.processing = false;
                        });
                },
                startService() {
                    this.showStartConfirm = true;
                },
                confirmStart() {
                    this.processing = true;
                    axios.post('/api/start')
                        .then(response => {
                            this.showStartConfirm = false;
                            if (response.data.success) {
                                this.showToast('服务已启动', 'success');
                                setTimeout(() => {
                                    this.loadStatus();
                                }, 5000); // 5秒后刷新状态
                            } else {
                                this.showToast('启动失败: ' + response.data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('启动失败:', error);
                            this.showToast('启动失败', 'error');
                        })
                        .finally(() => {
                            this.processing = false;
                        });
                }
            }
        };
        Vue.createApp(Dashboard).mount('#dashboardApp');
    });
</script>
{% endblock %} 