{% extends "base.html" %}

{% block title %}聊天管理 - 卡盟微信管理后台{% endblock %}

{% block page_title %}聊天管理{% endblock %}

{% block head %}
<style>
    /* 微信风格 CSS */
    .chat-container {
        display: flex;
        height: calc(100vh - 110px);
        background-color: #f5f5f5;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* 联系人侧边栏 */
    .chat-sidebar {
        width: 280px;
        background-color: #f8f8f8;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    
    .wx-search-box {
        padding: 12px;
        background-color: #f8f8f8;
        border-bottom: 1px solid #e5e5e5;
    }
    
    .wx-search-input {
        background-color: #e5e5e5;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .wx-search-input:focus {
        background-color: #fff;
        outline: none;
        box-shadow: 0 0 0 1px #07C160;
    }
    
    .wx-tabs {
        display: flex;
        background-color: #f8f8f8;
        border-bottom: 1px solid #e5e5e5;
    }
    
    .wx-tab {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        font-size: 15px;
        color: #666;
        cursor: pointer;
        position: relative;
    }
    
    .wx-tab.active {
        color: #07C160;
        font-weight: 500;
    }
    
    .wx-tab.active:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 25%;
        width: 50%;
        height: 2px;
        background-color: #07C160;
    }
    
    .wx-contact-list {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        margin: 0;
        list-style: none;
    }
    
    .wx-contact-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .wx-contact-item:hover {
        background-color: #f0f0f0;
    }
    
    .wx-contact-item.active {
        background-color: #e5e5e5;
    }
    
    .wx-avatar {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        font-size: 18px;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .wx-group-avatar {
        background-color: #07C160;
        color: white;
    }
    
    .wx-contact-info {
        flex: 1;
        overflow: hidden;
    }
    
    .wx-contact-name {
        font-size: 14px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* 聊天内容区域 */
    .chat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f5f5f5;
    }
    
    .wx-chat-header {
        padding: 12px 16px;
        background-color: #f8f8f8;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .wx-chat-title {
        font-size: 16px;
        font-weight: 500;
        color: #333;
    }
    
    .wx-chat-subtitle {
        font-size: 13px;
        color: #999;
        margin-left: 6px;
    }
    
    .wx-chat-messages {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        background-color: #ebebeb;
        display: flex;
        flex-direction: column;
    }
    
    .wx-empty-chat {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
    }
    
    .wx-empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: #ddd;
    }
    
    .wx-message {
        max-width: 65%;
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    
    .wx-message-received {
        align-self: flex-start;
    }
    
    .wx-message-sent {
        align-self: flex-end;
    }
    
    .wx-message-bubble {
        padding: 10px 12px;
        border-radius: 4px;
        font-size: 14px;
        line-height: 1.4;
        word-break: break-word;
    }
    
    .wx-message-received .wx-message-bubble {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 4px 4px 4px 0;
        color: #333;
    }
    
    .wx-message-sent .wx-message-bubble {
        background-color: #95ec69;
        border-radius: 4px 4px 0 4px;
        color: #000;
    }
    
    .wx-message-time {
        font-size: 12px;
        color: #aaa;
        margin-top: 3px;
        align-self: flex-end;
    }
    
    .wx-message-received .wx-message-time {
        align-self: flex-start;
    }
    
    .wx-chat-input-area {
        padding: 10px;
        background-color: #f8f8f8;
        border-top: 1px solid #e0e0e0;
    }
    
    .wx-chat-input-container {
        display: flex;
        align-items: center;
    }
    
    .wx-chat-input {
        flex: 1;
        border: none;
        background-color: #fff;
        border-radius: 4px;
        padding: 8px 12px;
        max-height: 80px;
        overflow-y: auto;
        resize: none;
        color: #333;
        font-size: 14px;
    }
    
    .wx-chat-input:focus {
        outline: none;
        box-shadow: 0 0 0 1px #07C160;
    }
    
    .wx-send-btn {
        background-color: #07C160;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        margin-left: 10px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .wx-send-btn:hover {
        background-color: #06ae56;
    }
    
    .wx-send-btn:disabled {
        background-color: #b2e3c9;
        cursor: not-allowed;
    }
    
    .wx-loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100px;
    }
    
    .wx-update-status {
        background-color: rgba(255,255,255,0.9);
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 8px 12px;
        margin: 8px;
    }
    
    .wx-progress {
        height: 4px;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
        background-color: #e0e0e0;
    }
    
    .wx-progress-bar {
        height: 100%;
        background-color: #07C160;
    }
    
    .wx-function-buttons {
        display: flex;
        background-color: #f8f8f8;
        padding: 8px;
        justify-content: space-around;
        border-bottom: 1px solid #e5e5e5;
    }
    
    .wx-function-btn {
        background: none;
        border: none;
        color: #07C160;
        font-size: 13px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
    }
    
    .wx-function-btn:hover {
        background-color: #e5e5e5;
    }
    
    .wx-function-btn i {
        font-size: 18px;
        margin-bottom: 4px;
    }
    
    /* 微信风格弹窗样式 */
    .wx-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 10px 16px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 9999;
        display: flex;
        align-items: center;
    }
    
    .wx-toast i {
        margin-right: 8px;
        font-size: 18px;
    }
    
    /* 调整滚动条样式 */
    ::-webkit-scrollbar {
        width: 4px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 2px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #999;
    }
</style>
{% endblock %}

{% block content %}
<div id="chatApp" class="h-[calc(100vh-110px)] bg-gray-50">
    <div class="h-full flex overflow-hidden rounded-xl shadow-sm">
        <!-- 联系人侧边栏 -->
        <div class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
            <!-- 搜索框 -->
            <div class="p-3 border-b border-gray-100 bg-gray-50">
                <div class="relative">
                    <input type="text" 
                           v-model="searchQuery" 
                           placeholder="搜索联系人或群组" 
                           class="w-full pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-full focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            
            <!-- 功能按钮区 -->
            <div class="flex p-2 bg-white border-b border-gray-100">
                <button @click="refreshContacts" class="flex-1 flex flex-col items-center justify-center py-1.5 px-2 rounded hover:bg-gray-100 text-xs font-medium text-gray-700 transition-colors">
                    <i class="fa-solid fa-arrows-rotate text-primary-500 mb-1 text-base"></i>
                    <span>刷新</span>
                </button>
                <button @click="updateContactsList('friends')" 
                        :disabled="updateStatus.friend_updating"
                        class="flex-1 flex flex-col items-center justify-center py-1.5 px-2 rounded hover:bg-gray-100 text-xs font-medium text-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-user-plus text-blue-500 mb-1 text-base"></i>
                    <span>更新好友</span>
                </button>
                <button @click="updateContactsList('groups')" 
                        :disabled="updateStatus.group_updating"
                        class="flex-1 flex flex-col items-center justify-center py-1.5 px-2 rounded hover:bg-gray-100 text-xs font-medium text-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-users-gear text-green-500 mb-1 text-base"></i>
                    <span>更新群组</span>
                </button>
            </div>
            
            <!-- 标签页切换 -->
            <div class="flex border-b border-gray-200">
                <button @click="activeTab = 'friends'" 
                        :class="{'text-primary-600 border-primary-500 font-medium': activeTab === 'friends'}"
                        class="flex-1 text-center py-3 px-1 text-sm border-b-2 border-transparent hover:border-gray-300 transition-colors focus:outline-none">
                    联系人
                </button>
                <button @click="activeTab = 'groups'" 
                        :class="{'text-primary-600 border-primary-500 font-medium': activeTab === 'groups'}"
                        class="flex-1 text-center py-3 px-1 text-sm border-b-2 border-transparent hover:border-gray-300 transition-colors focus:outline-none">
                    群聊
                </button>
            </div>
            
            <!-- 更新状态显示 -->
            <div v-if="updateStatus.friend_updating || updateStatus.group_updating" class="px-3 py-2 bg-blue-50 border-b border-blue-100">
                <div v-if="updateStatus.friend_updating" class="mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-600">好友更新中...</span>
                        <span class="text-xs text-gray-600">[[updateStatus.friend_current]]/[[updateStatus.friend_total]]</span>
                    </div>
                    <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500 rounded-full" 
                             :style="{width: (updateStatus.friend_current / updateStatus.friend_total * 100) + '%'}"></div>
                    </div>
                </div>
                <div v-if="updateStatus.group_updating">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-600">群组更新中...</span>
                        <span class="text-xs text-gray-600">[[updateStatus.group_current]]/[[updateStatus.group_total]]</span>
                    </div>
                    <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-green-500 rounded-full" 
                             :style="{width: (updateStatus.group_current / updateStatus.group_total * 100) + '%'}"></div>
                    </div>
                </div>
            </div>
            
            <!-- 加载中状态 -->
            <div v-if="loading" class="flex-1 flex justify-center items-center p-6">
                <div class="flex flex-col items-center">
                    <div class="w-8 h-8 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin mb-2"></div>
                    <p class="text-sm text-gray-500">加载联系人中...</p>
                </div>
            </div>
            
            <!-- 联系人列表 -->
            <div v-else class="flex-1 overflow-y-auto">
                <!-- 好友列表 -->
                <div v-if="activeTab === 'friends'" class="divide-y divide-gray-100">
                    <button v-for="friend in filteredFriends" 
                            :key="friend" 
                            @click="selectChat('friend', friend)"
                            :class="{'bg-primary-50': currentChat.type === 'friend' && currentChat.name === friend}"
                            class="w-full flex items-center px-3 py-2.5 hover:bg-gray-50 transition-colors focus:outline-none">
                        <div class="w-10 h-10 flex-shrink-0 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3 font-medium">
                            [[friend.charAt(0)]]
                        </div>
                        <div class="flex-1 min-w-0 text-left">
                            <div class="text-sm font-medium text-gray-900 truncate">[[friend]]</div>
                        </div>
                    </button>
                    <div v-if="filteredFriends.length === 0" class="py-10 flex flex-col items-center justify-center text-gray-500">
                        <i class="fa-solid fa-user-slash text-xl mb-2"></i>
                        <p class="text-sm">无匹配联系人</p>
                    </div>
                </div>
                
                <!-- 群组列表 -->
                <div v-else-if="activeTab === 'groups'" class="divide-y divide-gray-100">
                    <button v-for="group in filteredGroups" 
                            :key="group" 
                            @click="selectChat('group', group)"
                            :class="{'bg-primary-50': currentChat.type === 'group' && currentChat.name === group}"
                            class="w-full flex items-center px-3 py-2.5 hover:bg-gray-50 transition-colors focus:outline-none">
                        <div class="w-10 h-10 flex-shrink-0 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-3">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div class="flex-1 min-w-0 text-left">
                            <div class="text-sm font-medium text-gray-900 truncate">[[group]]</div>
                        </div>
                    </button>
                    <div v-if="filteredGroups.length === 0" class="py-10 flex flex-col items-center justify-center text-gray-500">
                        <i class="fa-solid fa-users-slash text-xl mb-2"></i>
                        <p class="text-sm">无匹配群组</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 聊天内容区域 -->
        <div class="flex-1 flex flex-col bg-gray-100">
            <!-- 未选择聊天时的状态 -->
            <div v-if="!currentChat.name" class="flex-1 flex flex-col items-center justify-center text-gray-400">
                <i class="fa-solid fa-comments text-5xl mb-4 opacity-30"></i>
                <p class="text-sm text-gray-500">请选择联系人开始聊天</p>
            </div>
            
            <!-- 已选择聊天的内容 -->
            <template v-else>
                <!-- 聊天头部 -->
                <div class="px-5 py-3 bg-white border-b border-gray-200 flex items-center justify-between shadow-sm">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 mr-3">
                            <!-- 好友头像 -->
                            <div v-if="currentChat.type === 'friend'" class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-medium">
                                [[currentChat.name.charAt(0)]]
                            </div>
                            <!-- 群组头像 -->
                            <div v-else class="w-9 h-9 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                <i class="fa-solid fa-users"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-base font-medium text-gray-900">[[currentChat.name]]</h3>
                            <div class="text-xs text-gray-500">
                                <span v-if="currentChat.type === 'friend'">联系人</span>
                                <span v-else>群聊</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 可以在这里添加更多的操作按钮，如搜索消息、更多选项等 -->
                    <div class="flex items-center">
                        <button class="p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors">
                            <i class="fa-solid fa-magnifying-glass text-sm"></i>
                        </button>
                        <button class="p-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors ml-1">
                            <i class="fa-solid fa-ellipsis-vertical text-sm"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 聊天消息区域 -->
                <div ref="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" style="scrollbar-width: thin;">
                    <!-- 暂无消息 -->
                    <div v-if="messages.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400">
                        <i class="fa-regular fa-comment-dots text-3xl mb-2"></i>
                        <p class="text-sm text-gray-500">暂无聊天记录</p>
                    </div>
                    
                    <!-- 消息列表 -->
                    <template v-else>
                        <div v-for="(message, index) in messages" :key="index" 
                             :class="{'flex justify-end': message.direction === 'sent', 'flex justify-start': message.direction === 'received'}" 
                             class="w-full">
                             
                            <!-- 收到的消息 -->
                            <div v-if="message.direction === 'received'" class="max-w-[75%] flex items-end">
                                <div v-if="currentChat.type === 'friend'" class="flex-shrink-0 mr-2 mb-1 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs">
                                    [[currentChat.name.charAt(0)]]
                                </div>
                                <div v-else class="flex-shrink-0 mr-2 mb-1 w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xs">
                                    <i class="fa-solid fa-users fa-xs"></i>
                                </div>
                                <div>
                                    <div class="bg-white rounded-lg px-3 py-2 shadow-sm border border-gray-200">
                                        <p class="text-sm text-gray-800 whitespace-pre-wrap break-words">[[message.content]]</p>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1 ml-1">[[formatTime(message.time)]]</div>
                                </div>
                            </div>
                            
                            <!-- 发送的消息 -->
                            <div v-else class="max-w-[75%] flex flex-col items-end">
                                <div class="bg-primary-500 rounded-lg px-3 py-2 shadow-sm">
                                    <p class="text-sm text-white whitespace-pre-wrap break-words">[[message.content]]</p>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 mr-1">[[formatTime(message.time)]]</div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- 输入区域 -->
                <div class="bg-white border-t border-gray-200 p-3">
                    <form @submit.prevent="sendMessage" class="flex items-end gap-2">
                        <div class="flex-1 rounded-lg border border-gray-300 overflow-hidden focus-within:ring-2 focus-within:ring-primary-500 focus-within:border-primary-500 bg-white">
                            <textarea 
                                ref="messageInput"
                                v-model="newMessage" 
                                @keydown.enter.prevent="handleEnterKey"
                                placeholder="输入消息..." 
                                class="w-full px-3 py-2 text-sm text-gray-800 focus:outline-none resize-none min-h-[44px] max-h-[120px]"
                                rows="1"></textarea>
                        </div>
                        <button 
                            type="submit" 
                            :disabled="!newMessage.trim() || sending"
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg flex items-center justify-center h-[44px] hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i :class="{'fa-solid fa-paper-plane': !sending, 'fa-solid fa-spinner fa-spin': sending}" class="text-sm"></i>
                            <span class="ml-1.5">发送</span>
                        </button>
                    </form>
                    
                    <!-- 提示信息 -->
                    <div class="text-xs text-gray-500 mt-1.5 pl-1 flex items-center">
                        <i class="fa-solid fa-circle-info text-xs mr-1 text-gray-400"></i>
                        按下 Enter 发送消息，Shift+Enter 换行
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- 提示消息 toast -->
    <div class="fixed bottom-4 right-4 z-50 max-w-sm transform transition-all duration-300 ease-in-out"
         :class="{'translate-y-0 opacity-100': showToast, 'translate-y-10 opacity-0 pointer-events-none': !showToast}">
        <div class="flex items-center p-4 rounded-lg shadow-lg text-white"
             :class="{'bg-green-600': toastSuccess, 'bg-red-600': !toastSuccess}">
            <div class="flex-shrink-0 mr-3">
                <i class="fa-solid" :class="{'fa-circle-check': toastSuccess, 'fa-circle-exclamation': !toastSuccess}"></i>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium">[[toastMessage]]</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ChatApp = {
            delimiters: ['[[', ']]'],
            data() {
                return {
                    friends: [],
                    groups: [],
                    loading: true,
                    searchQuery: '',
                    activeTab: 'friends',
                    currentChat: {
                        type: null,
                        name: null
                    },
                    messages: [],
                    newMessage: '',
                    sending: false,
                    socket: null,
                    showToast: false,
                    toastMessage: '',
                    toastSuccess: true,
                    toastTimer: null,
                    updateStatus: {
                        friend_updating: false,
                        friend_total: 0,
                        friend_current: 0,
                        group_updating: false,
                        group_total: 0,
                        group_current: 0
                    },
                    statusTimer: null,
                    autoRefreshTimer: null
                }
            },
            computed: {
                filteredFriends() {
                    if (!this.searchQuery) return this.friends;
                    const query = this.searchQuery.toLowerCase();
                    return this.friends.filter(friend => 
                        friend.toLowerCase().includes(query)
                    );
                },
                filteredGroups() {
                    if (!this.searchQuery) return this.groups;
                    const query = this.searchQuery.toLowerCase();
                    return this.groups.filter(group => 
                        group.toLowerCase().includes(query)
                    );
                }
            },
            watch: {
                messages() {
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                }
            },
            mounted() {
                // 先加载现有联系人列表
                this.loadContacts();
                
                // 设置WebSocket连接
                this.setupWebSocket();
                
                // 开始监控更新状态
                this.startStatusMonitoring();
                
                // 每60秒自动刷新联系人列表
                this.autoRefreshTimer = setInterval(() => {
                    // 只有当不在更新过程中才自动刷新
                    if (!this.updateStatus.friend_updating && !this.updateStatus.group_updating) {
                        this.loadContacts();
                    }
                }, 60000);
            },
            beforeUnmount() {
                // 清除自动刷新定时器
                if (this.autoRefreshTimer) {
                    clearInterval(this.autoRefreshTimer);
                }
                
                // 清除状态监控定时器
                if (this.statusTimer) {
                    clearInterval(this.statusTimer);
                }
                
                // 清除Toast定时器
                if (this.toastTimer) {
                    clearTimeout(this.toastTimer);
                }
            },
            methods: {
                // 开始监控更新状态
                startStatusMonitoring() {
                    // 立即获取一次状态
                    this.checkUpdateStatus();
                    
                    // 每2秒轮询一次状态
                    this.statusTimer = setInterval(() => {
                        // 只有在更新过程中才需要频繁轮询
                        if (this.updateStatus.friend_updating || this.updateStatus.group_updating) {
                            this.checkUpdateStatus();
                        }
                    }, 2000);
                },
                
                // 获取更新状态
                async checkUpdateStatus() {
                    try {
                        const response = await axios.get('/api/update_status');
                        if (response.data.success) {
                            this.updateStatus = response.data.data.status;
                        }
                    } catch (error) {
                        console.error('获取更新状态失败:', error);
                    }
                },
                
                // 手动触发更新联系人列表
                async updateContactsList(type) {
                    try {
                        if (type === 'friends' && this.updateStatus.friend_updating) {
                            this.showToastMessage('通讯录更新已在进行中', false);
                            return;
                        }
                        
                        if (type === 'groups' && this.updateStatus.group_updating) {
                            this.showToastMessage('群组详情更新已在进行中', false);
                            return;
                        }
                        
                        const endpoint = type === 'friends' ? '/api/update_friends' : '/api/update_rooms';
                        const response = await axios.post(endpoint);
                        
                        if (response.data.success) {
                            this.showToastMessage(`${type === 'friends' ? '通讯录' : '群组详情'}更新已开始`, true);
                            // 立即检查状态
                            this.checkUpdateStatus();
                        } else {
                            this.showToastMessage(response.data.message || '更新失败', false);
                        }
                    } catch (error) {
                        console.error('触发更新失败:', error);
                        this.showToastMessage('触发更新失败', false);
                    }
                },
                
                // 刷新联系人列表（仅从服务器加载缓存的联系人数据）
                refreshContacts() {
                    this.loadContacts();
                    this.showToastMessage('已刷新联系人列表', true);
                },
                
                // 加载联系人列表
                async loadContacts() {
                    try {
                        this.loading = true;
                        const response = await axios.get('/api/contacts');
                        if (response.data.success) {
                            this.friends = response.data.data.friends;
                            this.groups = response.data.data.groups;
                            
                            // 如果API返回需要更新的提示，显示提示消息
                            if (response.data.needs_update) {
                                this.showToastMessage(response.data.message || '请更新联系人数据', false);
                            }
                        } else {
                            console.error('加载联系人失败:', response.data.message);
                            this.showToastMessage('加载联系人失败', false);
                        }
                    } catch (error) {
                        console.error('加载联系人出错:', error);
                        this.showToastMessage('加载联系人出错', false);
                    } finally {
                        this.loading = false;
                    }
                },
                
                // 选择聊天对象
                selectChat(type, name) {
                    this.currentChat = { type, name };
                    this.loadChatHistory();
                    this.newMessage = ''; // 清空输入框
                },
                
                // 加载聊天历史
                async loadChatHistory() {
                    try {
                        this.loading = true;
                        const params = new URLSearchParams();
                        if (this.currentChat.type === 'friend') {
                            params.append('contact', this.currentChat.name);
                        } else {
                            params.append('group', this.currentChat.name);
                        }
                        params.append('page', 1);
                        params.append('page_size', 50);
                        
                        const response = await fetch(`/api/chat_history?${params.toString()}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            this.messages = data.data.map(msg => ({
                                content: msg.content,
                                direction: msg.is_sent ? 'sent' : 'received',
                                time: new Date(msg.timestamp * 1000)
                            }));
                        } else {
                            console.error('获取聊天历史失败:', data.message);
                            this.showToastMessage('获取聊天历史失败', false);
                            // 使用空数据
                            this.messages = [];
                        }
                    } catch (error) {
                        console.error('获取聊天历史失败:', error);
                        this.showToastMessage('获取聊天历史失败', false);
                        this.messages = [];
                    } finally {
                        this.loading = false;
                        this.$nextTick(() => {
                            this.scrollToBottom();
                        });
                    }
                },
                
                // 发送消息
                async sendMessage() {
                    if (!this.newMessage.trim() || this.sending) return;
                    
                    const messageText = this.newMessage.trim();
                    this.sending = true;
                    
                    // 先添加消息到UI
                    this.messages.push({
                        direction: 'sent',
                        content: messageText,
                        time: new Date()
                    });
                    
                    // 清空输入框
                    this.newMessage = '';
                    
                    try {
                        // 准备数据
                        const data = {
                            receiver_names: this.currentChat.type === 'friend' ? [this.currentChat.name] : [],
                            group_names: this.currentChat.type === 'group' ? [this.currentChat.name] : [],
                            content: messageText
                        };
                        
                        // 发送请求
                        const response = await axios.post('/api/direct_send_message', data, { withCredentials: true });
                        
                        if (response.data.success) {
                            this.showToastMessage('消息发送成功', true);
                        } else {
                            this.showToastMessage('消息发送失败：' + (response.data.message || '未知错误'), false);
                            console.error('发送消息失败:', response.data);
                        }
                    } catch (error) {
                        console.error('发送消息失败:', error);
                        // 检查是否重定向到登录页面
                        if (error.response && error.response.status === 302) {
                            this.showToastMessage('登录会话已过期，请重新登录', false);
                            // 2秒后重定向到登录页面
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                        } else {
                            this.showToastMessage('发送失败: ' + (error.response?.data?.message || error.message || '未知错误'), false);
                        }
                    } finally {
                        this.sending = false;
                        this.$nextTick(() => {
                            // 聚焦输入框并滚动到底部
                            this.$refs.messageInput.focus();
                            this.scrollToBottom();
                        });
                    }
                },
                
                // 处理回车键
                handleEnterKey(e) {
                    // Shift+Enter 换行，Enter 发送
                    if (!e.shiftKey) {
                        this.sendMessage();
                    } else {
                        // 在光标位置插入换行符
                        const start = this.$refs.messageInput.selectionStart;
                        const end = this.$refs.messageInput.selectionEnd;
                        this.newMessage = this.newMessage.substring(0, start) + '\n' + this.newMessage.substring(end);
                        this.$nextTick(() => {
                            this.$refs.messageInput.selectionStart = this.$refs.messageInput.selectionEnd = start + 1;
                        });
                    }
                },
                
                // 滚动到底部
                scrollToBottom() {
                    if (this.$refs.messagesContainer) {
                        this.$refs.messagesContainer.scrollTop = this.$refs.messagesContainer.scrollHeight;
                    }
                },
                
                // 设置WebSocket
                setupWebSocket() {
                    try {
                        this.socket = io();
                        
                        this.socket.on('connect', () => {
                            console.log('WebSocket连接成功');
                        });
                        
                        this.socket.on('chat_update', (data) => {
                            // 处理收到的消息
                            if ((data.receiver === this.currentChat.name && this.currentChat.type === 'friend') ||
                                (data.group === this.currentChat.name && this.currentChat.type === 'group')) {
                                this.messages.push({
                                    direction: 'received',
                                    content: data.message,
                                    time: new Date(data.timestamp * 1000)
                                });
                                
                                // 播放通知声音（可选）
                                // this.playNotificationSound();
                            }
                        });
                        
                        this.socket.on('disconnect', () => {
                            console.log('WebSocket连接断开');
                        });
                    } catch (error) {
                        console.error('设置WebSocket失败:', error);
                    }
                },
                
                // 格式化时间
                formatTime(time) {
                    try {
                        const date = new Date(time);
                        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    } catch (error) {
                        return '';
                    }
                },
                
                // 显示Toast消息
                showToastMessage(message, success) {
                    this.toastMessage = message;
                    this.toastSuccess = success;
                    this.showToast = true;
                    
                    if (this.toastTimer) {
                        clearTimeout(this.toastTimer);
                    }
                    
                    this.toastTimer = setTimeout(() => {
                        this.showToast = false;
                    }, 2000);
                }
            }
        };
        
        Vue.createApp(ChatApp).mount('#chatApp');
    });
</script>
{% endblock %} 